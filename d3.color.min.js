// CIE L*a*b* Color Space and Difference Metrics
// Uses formulae and matrices from http://brucelindbloom.com/
function d3_ciede2000(a,b){var c=1,d=1,e=1,f=Math.PI,g=a.L,h=a.a,i=a.b,j=Math.sqrt(h*h+i*i),k=b.L,l=b.a,m=b.b,n=Math.sqrt(l*l+m*m),o=.5*(j+n),p=.5*(1-Math.sqrt(Math.pow(o,7)/(Math.pow(o,7)+Math.pow(25,7)))),q=(1+p)*h,r=(1+p)*l,s=Math.sqrt(q*q+i*i),t=Math.sqrt(r*r+m*m),u=s*t,v=Math.atan2(i,q);v<0&&(v+=2*f);var w=Math.atan2(m,r);w<0&&(w+=2*f);var x=k-g,y=t-s,z=w-v;z>+f&&(z-=2*f),z<-f&&(z+=2*f),u==0&&(z=0);var A=2*Math.sqrt(u)*Math.sin(z/2),B=.5*(g+k),C=.5*(s+t),D=.5*(v+w);Math.abs(v-w)>f&&(D-=f),D<0&&(D+=2*f),u==0&&(D=v+w);var E=(B-50)*(B-50),F=1+.015*E/Math.sqrt(20+E),G=1+.045*C,H=1-.17*Math.cos(D-f/6)+.24*Math.cos(2*D)+.32*Math.cos(3*D+f/30)-.2*Math.cos(4*D-63*f/180),I=1+.015*C*H,J=(180/f*D-275)/25,K=30*f/180*Math.exp(-1*J*J),L=2*Math.sqrt(Math.pow(C,7)/(Math.pow(C,7)+Math.pow(25,7))),M=-1*Math.sin(2*K)*L;x=x/(c*F),y=y/(d*G),A=A/(e*I);return Math.sqrt(x*x+y*y+A*A+M*y*A)}function d3_cie94(a,b){var c=a.L-b.L,d=a.a-b.a,e=a.b-b.b,f=Math.sqrt(a.a*a.a+a.b*a.b),g=Math.sqrt(b.a*b.a+b.b*b.b),h=f-g,i=Math.sqrt(d*d+e*e-h*h);h=h/(1+.045*f),i=i/(1+.015*f);return Math.sqrt(c*c+h*h+i*i)}function d3_cie76(a,b){var c=a.L-b.L,d=a.a-b.a,e=a.b-b.b;return Math.sqrt(c*c+d*d+e*e)}function d3_rgb_lab(a,b,c){a=a/255,b=b/255,c=c/255;var d=.95047,e=1,f=1.08883;a=a<=.04045?a/12.92:Math.pow((a+.055)/1.055,2.4),b=b<=.04045?b/12.92:Math.pow((b+.055)/1.055,2.4),c=c<=.04045?c/12.92:Math.pow((c+.055)/1.055,2.4);var g=(.4124564*a+.3575761*b+.1804375*c)/d,h=(.2126729*a+.7151522*b+.072175*c)/e,i=(.0193339*a+.119192*b+.9503041*c)/f;g=g>.008856?Math.pow(g,1/3):7.787037*g+4/29,h=h>.008856?Math.pow(h,1/3):7.787037*h+4/29,i=i>.008856?Math.pow(i,1/3):7.787037*i+4/29;return d3_lab(116*h-16,500*(g-h),200*(h-i))}function d3_lab_rgb(a,b,c){var d=(a+16)/116,e=d+b/500,f=d-c/200,g=.95047,h=1,i=1.08883;e=g*(e>.206893034?e*e*e:(e-4/29)/7.787037),d=h*(d>.206893034?d*d*d:(d-4/29)/7.787037),f=i*(f>.206893034?f*f*f:(f-4/29)/7.787037);var j=3.2404542*e-1.5371385*d-.4985314*f,k=-0.969266*e+1.8760108*d+.041556*f,c=.0556434*e-.2040259*d+1.0572252*f;j=j<=.00304?12.92*j:1.055*Math.pow(j,1/2.4)-.055,k=k<=.00304?12.92*k:1.055*Math.pow(k,1/2.4)-.055,c=c<=.00304?12.92*c:1.055*Math.pow(c,1/2.4)-.055,j=Math.round(255*j),k=Math.round(255*k),c=Math.round(255*c);var l=d3.rgb(Math.max(0,Math.min(255,j)),Math.max(0,Math.min(255,k)),Math.max(0,Math.min(255,c)));if(j<0||j>255||k<0||k>255||c<0||c>255)l.clipped=!0;return l}function d3_Lab(a,b,c){this.L=a,this.a=b,this.b=c}function d3_lab(a,b,c){return new d3_Lab(a,b,c)}d3.lab=function(a,b,c){if(arguments.length==1){var d=d3.rgb(a);return d3_rgb_lab(d.r,d.g,d.b)}return d3_lab(a,b,c)},d3_Lab.prototype.rgb=function(){return d3_lab_rgb(this.L,this.a,this.b)},d3_Lab.prototype.toString=function(){return this.rgb().toString()},d3_Lab.prototype.distance=function(a){return d3_cie76(this,a)},d3_Lab.prototype.de76=function(a){return d3_cie76(this,a)},d3_Lab.prototype.de94=function(a){return d3_cie94(this,a)},d3_Lab.prototype.de00=function(a){return d3_ciede2000(this,a)}